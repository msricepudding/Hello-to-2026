<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>2025 跨年 3D 互动相册</title>
    <style>
        body { margin: 0; background: #000005; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #f5d5d0; z-index: 10;
        }
        button {
            padding: 15px 40px; font-size: 18px; cursor: pointer;
            background: rgba(224, 163, 154, 0.1); border: 2px solid #ffb6c1; color: #ffb6c1;
            border-radius: 30px; transition: all 0.3s; backdrop-filter: blur(5px);
        }
        button:hover { background: #E0A39A; color: #000; box-shadow: 0 0 30px #E0A39A; }
        #status { position: absolute; bottom: 20px; left: 20px; color: rgba(255, 182, 193, 0.5); font-size: 12px; }
        #loading-bar { position: fixed; top: 0; left: 0; height: 4px; background: #ffb6c1; width: 0%; z-index: 1000; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="loading-bar"></div>
    <div id="overlay">
        <h1 style="letter-spacing: 8px; font-weight: 200; text-shadow: 0 0 15px #E0A39A;">Happy New Year 2025</h1>
        <button id="startBtn">开启 3D 奢华互动</button>
    </div>
    <div id="status">手势状态: 等待开启摄像头...</div>
    <video id="video" style="display:none;" autoplay playsinline></video>
    <canvas id="main-canvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        let scene, camera, renderer, coreLight, heartGroup, stars;
        let photos = [];
        let isExploded = false;
        let mouseX = 0, mouseY = 0;
        let photoCount = 21;

        function initScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000008, 0.012);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('main-canvas'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ReinhardToneMapping;

            // 核心黄金光源 - 增强亮度
            coreLight = new THREE.PointLight(0xFFD700, 25, 100);
            scene.add(coreLight);

            createStarField();
            createHeartAlbum();
            animate();
        }

        // 创建更密集、闪烁的星光
        function createStarField() {
            const starGeo = new THREE.BufferGeometry();
            const positions = [];
            const sizes = [];
            const twinks = [];

            for(let i=0; i<5000; i++) {
                positions.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*200);
                sizes.push(Math.random() * 0.15 + 0.05);
                twinks.push(Math.random() * Math.PI); // 随机相位
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            starGeo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            
            const starMat = new THREE.PointsMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true,
                blending: THREE.AdditiveBlending
            });
            stars = new THREE.Points(starGeo, starMat);
            scene.add(stars);
            stars.userData.twinks = twinks;
        }

        function createHeartAlbum() {
            heartGroup = new THREE.Group();
            scene.add(heartGroup);

            // 玫瑰金材质增强
            const frameMat = new THREE.MeshStandardMaterial({ 
                color: 0xFFB6C1, 
                metalness: 1.0, 
                roughness: 0.1, 
                emissive: 0xE0A39A,
                emissiveIntensity: 0.6 
            });

            const textureLoader = new THREE.TextureLoader();
            let loadedFiles = 0;

            for(let i=1; i<=photoCount; i++) {
                const group = new THREE.Group();
                const photoGeo = new THREE.PlaneGeometry(3, 4);
                // 默认占位色
                const photoMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
                const photoMesh = new THREE.Mesh(photoGeo, photoMat);

                const frameGeo = new THREE.BoxGeometry(3.3, 4.3, 0.15);
                const frameMesh = new THREE.Mesh(frameGeo, frameMat);
                frameMesh.position.z = -0.1;

                group.add(photoMesh, frameMesh);

                // 爱心公式
                const t = (i / photoCount) * Math.PI * 2;
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                
                group.position.set(x * 1.2, y * 1.2, (Math.random()-0.5)*10);
                group.userData = { 
                    homePos: group.position.clone(), 
                    targetPos: new THREE.Vector3(),
                    rotSpeed: new THREE.Vector3(Math.random()*0.05, Math.random()*0.05, Math.random()*0.05)
                };

                // 加载照片 photo_1.jpg 到 photo_21.jpg
                const imgName = `images/photo_${i}.jpg`;
                textureLoader.load(imgName, (tex) => {
                    photoMat.map = tex;
                    photoMat.needsUpdate = true;
                    loadedFiles++;
                    document.getElementById('loading-bar').style.width = (loadedFiles/photoCount*100) + '%';
                    if(loadedFiles === photoCount) document.getElementById('loading-bar').style.display='none';
                }, undefined, (err) => console.warn(`加载失败: ${imgName}`));

                photos.push(group);
                heartGroup.add(group);
            }
        }

        function triggerExplode() {
            if(isExploded) return;
            isExploded = true;
            photos.forEach(p => {
                const dist = 40 + Math.random() * 40;
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;
                p.userData.targetPos.set(
                    dist * Math.sin(theta) * Math.cos(phi),
                    dist * Math.sin(theta) * Math.sin(phi),
                    dist * Math.cos(theta)
                );
            });
        }

        function triggerAssemble() { isExploded = false; }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            // 心跳
            const s = 1 + Math.sin(time * 4) * 0.04;
            heartGroup.scale.set(s, s, s);
            coreLight.intensity = 20 + Math.sin(time * 6) * 10;

            // 星光闪烁
            if(stars) {
                stars.rotation.y += 0.0005;
                stars.material.opacity = 0.5 + Math.sin(time * 2) * 0.3;
            }

            photos.forEach(p => {
                const target = isExploded ? p.userData.targetPos : p.userData.homePos;
                p.position.lerp(target, 0.06);
                if(isExploded) {
                    p.rotation.x += p.userData.rotSpeed.x;
                    p.rotation.y += p.userData.rotSpeed.y;
                } else {
                    p.quaternion.slerp(new THREE.Quaternion(), 0.1);
                }
            });

            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;
            camera.lookAt(0,0,0);

            renderer.render(scene, camera);
        }

        // MediaPipe
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.75 });
        hands.onResults(res => {
            if(res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const lm = res.multiHandLandmarks[0];
                document.getElementById('status').innerText = "手势控制中...";
                mouseX = (lm[9].x - 0.5) * 60;
                mouseY = (lm[9].y - 0.5) * 60;
                
                // 判断逻辑：指尖距离
                const isOpen = lm[8].y < lm[6].y && lm[12].y < lm[10].y && lm[16].y < lm[14].y;
                if(isOpen) triggerExplode(); 
                else if(lm[8].y > lm[5].y) triggerAssemble();
            } else {
                document.getElementById('status').innerText = "未检测到手部";
            }
        });

        document.getElementById('startBtn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            initScene();
            const cam = new Camera(document.getElementById('video'), {
                onFrame: async () => { await hands.send({image: document.getElementById('video')}); },
                width: 640, height: 480
            });
            cam.start();
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
